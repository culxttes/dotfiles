#!/usr/bin/env bash

# NixOS Flake Pre-Commit Hook
# This hook checks if Nix files are properly formatted before committing

set -euo pipefail

echo "ðŸŽ¨ Checking Nix file formatting..."
echo "----------------------------------------"

# Check if we're in a directory with a flake
if [ ! -f "flake.nix" ]; then
    echo "âš ï¸  Warning: No flake.nix found. Skipping check."
    exit 0
fi

# Get list of staged .nix files
STAGED_NIX_FILES=$(git diff --staged --name-only --diff-filter=ACM)

if [ -z "$STAGED_NIX_FILES" ]; then
    echo "â„¹ï¸  No files staged for commit."
    exit 0
fi

echo "ðŸ“ Checking formatting for:"
echo "$STAGED_NIX_FILES" | sed 's/^/  - /'
echo ""

# Check if files are formatted
UNFORMATTED_FILES=()
while IFS= read -r file; do
    if [ -f "$file" ]; then
        nix fmt "$file" 2>/dev/null
        if ! git diff --quiet -- "$file"; then
            UNFORMATTED_FILES+=("$file")
        fi
    fi
done <<< "$STAGED_NIX_FILES"

if [ ${#UNFORMATTED_FILES[@]} -gt 0 ]; then
    echo "----------------------------------------"
    echo "âŒ The following files were not properly formatted:"
    printf '  - %s\n' "${UNFORMATTED_FILES[@]}"
    echo ""
    echo "âŒ Commit blocked. Please git add before committing."
    exit 1
else
    echo "----------------------------------------"
    echo "âœ… All Nix files are properly formatted!"
    echo "âœ… Commit allowed."
    exit 0
fi
